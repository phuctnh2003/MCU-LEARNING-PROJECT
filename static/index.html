<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="/static/css/index.css">
    <link href="https://fonts.googleapis.com/css?family=Fira+Sans" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <title>Giao diện học tập</title>
</head>

<body>
    <div id="loading-overlay">
        <div class="spinner"></div>
        <div>Trying to reconnect...</div>
    </div>
    <div class="main-box">
        <!-- MENU BUTTON -->
        <button class="menu-button" id="openMenu">☰</button>
        <!-- MENU BÊN TRÁI -->
        <div class="sidebar" id="sidebar">
            <div class="menu-close" id="closeMenu">✖</div>
            <div class="sidebar-item" onclick="showTab('home')">
                <img src="/static/images/ri_dashboard-fill.svg" class="icon" /> Home
            </div>
            <div class="sidebar-item" onclick="showTab('connection')">
                <img src="/static/images/icon_connected.svg" class="icon" sizes="30x40" /> Connection
            </div>
            <div class="sidebar-item" onclick="showTab('account')">
                <img src="/static/images/account.png" class="icon" sizes="30x40" /> Account
            </div>
            <div class="sidebar-item" id="logout-btn">
                <img src="/static/images/logout.png" class="icon" sizes="20x20" /> Logout
            </div>
        </div>

        <!-- KHUNG TRẮNG NỘI DUNG -->
        <div class="content">
            <!-- TAB HOME -->
            <div id="home" class="tab active">
                <div class="user-info">
                    <img src="/static/images/Logo-TA.png" class="logo-img" />
                    <div class="user-meta">
                        <img src="/static/images/user-avatar-100.png" class="user-avatar" />
                        <span id="username-display" class="username"></span>
                        <span class="status-dot online"></span>
                    </div>
                </div>
                <div style="max-width: 1500px; width: 100%;">
                    <div class="header-row">
                        <h2>Templates</h2>
                        <input type="text" id="searchInput" onkeyup="filterButtons()"
                            placeholder="Search templates..." />
                    </div>
                    <div id="buttonContainer"></div>
                </div>
            </div>

            <!-- TAB Connection -->
            <!-- TAB Connection - Phiên bản nâng cấp -->
            <div id="connection" class="tab">
                <div class="connection-header">
                    <h2>Connecting device</h2>

                </div>

                <div class="device-list">
                    <div class="device-card">
                        <div class="device-icon">
                            <img src="/static/images/raspberry-pi-logo.svg" alt="Raspberry Pi">
                        </div>
                        <div class="device-info">
                            <div class="device-name" id="deviceName"></div>
                            <div class="device-id">ID: <span id="deviceIdDisplay"></span></div>
                        </div>
                        <div class="device-status-container">
                            <div class="connection-status">
                                <span class="status-indicator"></span>
                                <span class="status-text" id="deviceStatusText">Checking...</span>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="deviceToggle" disabled>
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>
                </div>



            </div>

            <!-- TAB ACCOUNT -->
            <div id="account" class="tab">
                <div class="user-info">
                    <img src="/static/images/Logo-TA.png" class="logo-img" />
                    <div class="user-meta">
                        <img src="/static/images/user-avatar-100.png" class="user-avatar" />
                        <span id="profile-username-display" class="username"></span>
                        <span class="status-dot online"></span>
                    </div>
                </div>

                <div class="account-wrapper">
                    <div class="account-card">
                        <h2 style="font-size: 24px; margin-bottom: 20px; color: #333; font-weight: normal;">Personal
                            information</h2>
                        <p style="font-size: 16px; color: #666; margin-bottom: 30px;">
                            Manage your personal information, including username, email address where you can be
                            contacted
                        </p>

                        <div class="account-layout">
                            <!-- Phần bên trái - Logo và nút reset -->
                            <div class="account-left">
                                <div class="user-profile">
                                    <div class="user-avatar-large">
                                        <img src="/static/images/user-avatar-100.png" sizes="100x100" />
                                    </div>
                                    <h3 id="profile-name-display"></h3>
                                    <p id="profile-email-display"></p>
                                </div>

                                <button class="reset-password-btn" id="resetPasswordBtn">
                                    <img src="/static/images/reset-password.png" alt="Reset Password" />
                                    Reset Password
                                </button>
                            </div>

                            <!-- Phần bên phải - Thông tin cá nhân -->
                            <div class="account-right">
                                <div class="info-grid">
                                    <div class="info-item">
                                        <div class="info-content">
                                            <div class="info-label">Username</div>
                                            <div class="info-value" id="account-username-display"></div>
                                        </div>
                                        <img src="/static/images/username.png" class="info-icon" />
                                    </div>

                                    <div class="info-item">
                                        <div class="info-content">
                                            <div class="info-label">Name</div>
                                            <div class="info-value" id="account-name-display"></div>
                                        </div>
                                        <img src="/static/images/name.png" class="info-icon" />
                                    </div>

                                    <div class="info-item">
                                        <div class="info-content">
                                            <div class="info-label">Email</div>
                                            <div class="info-value" id="account-email-display"></div>
                                        </div>
                                        <img src="/static/images/email.png" class="info-icon" />
                                    </div>

                                    <div class="info-item">
                                        <div class="info-content">
                                            <div class="info-label">Device ID</div>
                                            <div class="info-value" id="account-device-display"></div>
                                        </div>
                                        <img src="/static/images/pi.png" class="info-icon" />
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        let deviceIdGlobal = null;
        let currentUser = {
            username: '',
            name: '',
            email: '',
            device_id: ''
        };
        const sidebar = document.getElementById('sidebar');
        const openMenu = document.getElementById('openMenu');
        const closeMenu = document.getElementById('closeMenu');
        const buttonContainer = document.getElementById('buttonContainer');
        const templates = [
            { name: 'I2C', description: 'Giao tiếp I2C cơ bản' },
            { name: 'LED Blink', description: 'Nhấp nháy LED' },
            { name: 'UART', description: 'Truyền thông UART' },
            { name: 'ADC Read', description: 'Đọc ADC' },
            { name: 'LCD Display', description: 'Hiển thị trên LCD' },
            { name: 'Button Control', description: 'Điều khiển nút nhấn' }
        ];

        // Thêm các biến quản lý trạng thái thiết bị
        const deviceToggle = document.getElementById('deviceToggle1');
        const deviceStatus = document.getElementById('deviceStatus1');
        const deviceName = document.querySelector('.device-name');
        let deviceStatusInterval = null;

        openMenu.addEventListener('click', () => {
            sidebar.classList.add('active');
            openMenu.style.display = 'none';
        });

        closeMenu.addEventListener('click', () => {
            sidebar.classList.remove('active');
            openMenu.style.display = 'block';
        });

        function showTab(id) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            sidebar.classList.remove('active');
            openMenu.style.display = 'block';

            // Quản lý interval kiểm tra trạng thái thiết bị
            if (id === 'connection') {
                updateConnectionTab();
                // Kiểm tra trạng thái mỗi 10 giây khi ở tab connection
                if (this.connectionInterval) clearInterval(this.connectionInterval);
                this.connectionInterval = setInterval(updateConnectionTab, 10000);
            } else {
                if (this.connectionInterval) {
                    clearInterval(this.connectionInterval);
                    this.connectionInterval = null;
                }
            }
        }

        // Hàm bắt đầu kiểm tra trạng thái thiết bị
        function startDeviceStatusMonitoring() {
            if (deviceStatusInterval) clearInterval(deviceStatusInterval);
            checkDeviceStatus(); // Kiểm tra ngay lập tức
            deviceStatusInterval = setInterval(checkDeviceStatus, 3000); // Kiểm tra mỗi 3 giây
        }

        // Hàm kiểm tra trạng thái thiết bị
        async function checkDeviceStatus() {
            if (!deviceIdGlobal) return;

            try {
                const res = await fetch(`/check_device_status?device_id=${deviceIdGlobal}`);
                if (res.ok) {
                    const data = await res.json();
                    updateDeviceStatusUI(data.online);
                    updateStatusDot(data.online);

                    if (!data.online) {
                        await attemptReconnect();
                    }
                }
            } catch (err) {
                console.error("Error checking device status:", err);
                updateDeviceStatusUI(false);
                updateStatusDot(false);
            }
        }

        async function updateConnectionTab() {
            if (!deviceIdGlobal) return;

            // Cập nhật thông tin thiết bị
            document.getElementById('deviceIdDisplay').textContent = deviceIdGlobal;
            document.getElementById('deviceName').textContent = currentUser.device_id || 'Raspberry Pi';

            try {
                // Gọi API kiểm tra trạng thái
                const res = await fetch(`/check_device_status?device_id=${deviceIdGlobal}`);
                if (res.ok) {
                    const data = await res.json();
                    const isOnline = data.online;

                    // Cập nhật giao diện
                    const statusIndicator = document.querySelector('.status-indicator');
                    const statusText = document.getElementById('deviceStatusText');
                    const toggle = document.getElementById('deviceToggle');

                    statusIndicator.className = 'status-indicator ' + (isOnline ? 'online' : 'offline');
                    statusText.textContent = isOnline ? 'Connected' : 'Disconnected';
                    statusText.style.color = isOnline ? '#2ecc71' : '#e74c3c';
                    toggle.checked = isOnline;
                }
            } catch (error) {
                console.error("Error updating connection tab:", error);
                const statusIndicator = document.querySelector('.status-indicator');
                const statusText = document.getElementById('deviceStatusText');

                statusIndicator.className = 'status-indicator offline';
                statusText.textContent = 'Mất kết nối';
                statusText.style.color = '#e74c3c';
            }
        }

        // Hàm cập nhật giao diện trạng thái thiết bị
        function updateDeviceStatusUI(isOnline) {
            if (deviceToggle && deviceStatus) {
                // Chỉ cập nhật trạng thái, không cho phép tương tác
                deviceToggle.checked = isOnline;
                deviceStatus.textContent = isOnline ? 'Đang kết nối' : 'Mất kết nối';
                deviceStatus.style.color = isOnline ? '#4CAF50' : '#f44336';

                // Thêm style để làm rõ toggle không thể tương tác
                const slider = document.querySelector('.slider');
                if (slider) {
                    slider.style.cursor = 'not-allowed';
                    slider.style.opacity = '0.7';
                }
            }
        }

        function renderButtons(filterText = '') {
            buttonContainer.innerHTML = '';
            const filtered = templates.filter(t =>
                t.name.toLowerCase().includes(filterText.toLowerCase())
            );

            if (filtered.length === 0) {
                buttonContainer.innerHTML = '<p>No templates found.</p>';
                return;
            }

            filtered.forEach(t => {
                const btn = document.createElement('button');
                btn.className = 'template-button';
                btn.innerHTML = `
                <div>${t.name}</div>
                <div class="description">${t.description}</div>
            `;
                btn.onclick = () => alert('Bạn đã chọn: ' + t.name);
                buttonContainer.appendChild(btn);
            });
        }

        function filterButtons() {
            const keyword = document.getElementById('searchInput').value;
            renderButtons(keyword);
        }

        function showToast(type, title, text) {
            Swal.fire({
                icon: type,
                title: title,
                text: text,
                timer: 2000,
                timerProgressBar: true,
                showConfirmButton: false
            });
        }

        function showLoading(show) {
            document.getElementById("loading-overlay").style.display = show ? "flex" : "none";
        }

        function parseJwt(token) {
            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(atob(base64).split('').map(function (c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));
                return JSON.parse(jsonPayload);
            } catch (e) {
                console.error("Failed to parse JWT:", e);
                return null;
            }
        }

        function updateUserInfoDisplays() {
            document.getElementById("username-display").textContent = currentUser.username;
            document.getElementById("profile-username-display").textContent = currentUser.username;
            document.getElementById("account-username-display").textContent = currentUser.username;
            document.getElementById("profile-name-display").textContent = currentUser.name;
            document.getElementById("account-name-display").textContent = currentUser.name;
            document.getElementById("profile-email-display").textContent = currentUser.email;
            document.getElementById("account-email-display").textContent = currentUser.email;
            document.getElementById("account-device-display").textContent = currentUser.device_id;

            // Cập nhật tên thiết bị trong tab connection
            if (deviceName && currentUser.device_id) {
                deviceName.textContent = `Device: ${currentUser.device_id}`;
            }
        }
        async function fetchUserInfo() {
            const token = localStorage.getItem("jwt_token");
            if (!token) {
                showToast("error", "Missing Token", "Please log in again.");
                window.location.href = "/";
                return;
            }

            const payload = parseJwt(token);

            if (!payload || !payload.device_id) {
                showToast("error", "Invalid Token", "Token format is invalid. Please log in again.");
                localStorage.removeItem("jwt_token");
                updateStatusDot(false);
                window.location.href = "/";
                return;
            }

            deviceIdGlobal = payload.device_id;
            console.log("Parsed payload:", payload);
            console.log("deviceIdGlobal:", deviceIdGlobal);

            try {
                const initialStatusRes = await fetch(`/check_device_status?device_id=${deviceIdGlobal}`);
                if (initialStatusRes.ok) {
                    const initialStatusData = await initialStatusRes.json();
                    updateStatusDot(initialStatusData.online);
                    updateDeviceStatusUI(initialStatusData.online);
                }
            } catch (err) {
                console.error("Initial status check failed:", err);
                updateStatusDot(false);
                updateConnectionTab();
            }

            try {
                const response = await fetch("/user_info", {
                    method: "GET",
                    headers: {
                        Authorization: "Bearer " + token
                    }
                });

                const data = await response.json();

                if (response.status === 200) {
                    currentUser = {
                        username: data.username || 'N/A',
                        name: data.name || 'N/A',
                        email: data.email || 'N/A',
                        device_id: data.device_id || 'N/A'
                    };

                    updateUserInfoDisplays();
                    startDeviceStatusMonitoring(); // Bắt đầu kiểm tra trạng thái sau khi có thông tin user

                } else {
                    handleApiError(data);
                    localStorage.removeItem("jwt_token");
                    updateStatusDot(false);
                    window.location.href = "/";
                }
            } catch (err) {
                console.error("Error fetching user info:", err);
                updateStatusDot(false);
                showToast("error", "Network Error", "Unable to fetch user info.");
            }
        }

        document.getElementById("logout-btn").addEventListener("click", async () => {
            const token = localStorage.getItem("jwt_token");
            if (!token) {
                window.location.href = "/";
                return;
            }

            try {
                const response = await fetch("/logout", {
                    method: "POST",
                    headers: {
                        Authorization: "Bearer " + token
                    }
                });

                const data = await response.json();

                if (response.ok) {
                    localStorage.removeItem("jwt_token");
                    window.location.href = "/";
                } else {
                    handleApiError(data);
                }
            } catch (error) {
                console.error("Logout error:", error);
                showToast("error", "Logout Failed", "An error occurred during logout.");
            }
        });

        function updateStatusDot(isOnline) {
            const statusDots = document.querySelectorAll('.status-dot');

            statusDots.forEach(dot => {
                dot.classList.remove('online', 'offline');
                dot.classList.add(isOnline ? 'online' : 'offline');
            });
        }

        async function attemptReconnect() {
            updateStatusDot(false);
            updateDeviceStatusUI(false);

            const confirmReconnect = await Swal.fire({
                icon: "warning",
                title: "Device Offline",
                text: "Raspberry Pi is currently offline. Do you want to retry?",
                showCancelButton: true,
                confirmButtonText: "Reconnect",
                cancelButtonText: "Logout"
            });

            if (!confirmReconnect.isConfirmed) {
                await logoutUser();
                return;
            }

            showLoading(true);
            await new Promise(resolve => setTimeout(resolve, 5000));

            try {
                const reconnectRes = await fetch(`/check_device_status?device_id=${deviceIdGlobal}`);
                showLoading(false);
                if (reconnectRes.ok) {
                    const reconnectData = await reconnectRes.json();
                    updateStatusDot(reconnectData.online);
                    updateDeviceStatusUI(reconnectData.online);

                    if (reconnectData.online) {
                        showToast("success", "Reconnected", "Raspberry Pi is back online.");
                    } else {
                        await attemptReconnect();
                    }
                } else {
                    await attemptReconnect();
                }
            } catch (e) {
                console.error("Reconnect failed:", e);
                showLoading(false);
                await attemptReconnect();
            }
        }

        async function logoutUser() {
            const token = localStorage.getItem("jwt_token");
            if (!token) {
                window.location.href = "/";
                return;
            }

            try {
                await fetch("/logout", {
                    method: "POST",
                    headers: {
                        Authorization: "Bearer " + token
                    }
                });
            } catch (e) {
                console.error("Logout error:", e);
            }

            localStorage.removeItem("jwt_token");
            updateStatusDot(false);
            updateDeviceStatusUI(false);
            stopDeviceStatusMonitoring();
            window.location.href = "/";
        }

        function handleApiError(data) {
            const code = data?.code;
            const message = data?.message || "Unknown error";

            switch (code) {
                case 1203: // MISSING_TOKEN
                    showToast("error", "Missing Token", message);
                    break;
                case 1208: // INVALID_TOKEN_FORMAT
                    showToast("error", "Invalid Token Format", message);
                    break;
                case 1205: // TOKEN_EXPIRED
                    showToast("error", "Token Expired", message);
                    break;
                case 1204: // INVALID_TOKEN
                    showToast("error", "Invalid Token", message);
                    break;
                case 1206: // USER_NOT_FOUND
                    showToast("error", "User Not Found", message);
                    break;
                case 1201: // INTERNAL_ERROR
                    showToast("error", "Server Error", message);
                    break;
                case 1204: // MISSING_DEVICE_ID
                    showToast("error", "Missing Device ID", message);
                    break;
                default:
                    showToast("error", "Error", message);
            }
        }

        // Xử lý reset password
        document.getElementById('resetPasswordBtn').addEventListener('click', function () {
            Swal.fire({
                title: 'Change Password',
                html: `
                <input type="password" id="oldPassword" class="swal2-input" placeholder="Old Password">
                <input type="password" id="newPassword" class="swal2-input" placeholder="New Password">
                <label style="display:flex;align-items:center;justify-content:center;margin-top:5px;">
                    <input type="checkbox" id="showPasswordToggle" style="margin-right:5px;"> Show Passwords
                </label>
            `,
                confirmButtonText: 'Change',
                showCancelButton: true,
                focusConfirm: false,
                didOpen: () => {
                    document.getElementById('showPasswordToggle').addEventListener('change', function () {
                        const oldInput = document.getElementById('oldPassword');
                        const newInput = document.getElementById('newPassword');
                        const type = this.checked ? 'text' : 'password';
                        oldInput.type = type;
                        newInput.type = type;
                    });
                },
                preConfirm: () => {
                    const oldPass = document.getElementById('oldPassword').value;
                    const newPass = document.getElementById('newPassword').value;

                    if (!oldPass || !newPass) {
                        Swal.showValidationMessage('Please fill in both fields');
                        return false;
                    }

                    return fetch('/change_password', {
                        method: 'POST',
                        headers: {
                            'Authorization': 'Bearer ' + localStorage.getItem('jwt_token'),
                        },
                        body: new URLSearchParams({
                            old_password: oldPass,
                            new_password: newPass
                        })
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.code === 0) {
                                return data;
                            } else {
                                throw new Error(data.message);
                            }
                        })
                        .catch(error => {
                            Swal.showValidationMessage(`Request failed: ${error.message}`);
                        });
                }
            }).then((result) => {
                if (result.isConfirmed && result.value) {
                    Swal.fire('Success', 'Password changed successfully!', 'success');
                }
            });
        });

        // Khởi động ứng dụng
        document.addEventListener('DOMContentLoaded', function () {
            fetchUserInfo();
            renderButtons();
        });
    </script>
</body>

</html>