<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard</title>
  <style>
    #loading-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background-color: rgba(0, 0, 0, 0.6);
      z-index: 9999;
      justify-content: center;
      align-items: center;
      color: white;
      font-size: 24px;
      flex-direction: column;
    }

    .spinner {
      border: 6px solid #f3f3f3;
      border-top: 6px solid #00ff88;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    #success-popup {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #4CAF50;
      color: white;
      padding: 10px 20px;
      border-radius: 8px;
      display: none;
      z-index: 99999;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
    }
  </style>
</head>
<body>
  <h1>Welcome, <span id="username"></span></h1>
  <p>Email: <span id="email"></span></p>
  <p>Name: <span id="name"></span></p>
  <button style="color: red;" id="logout-btn">Logout</button>

  <div id="loading-overlay">
    <div class="spinner"></div>
    <div>Đang thử kết nối lại...</div>
  </div>

  <div id="success-popup">✅ Kết nối lại thành công!</div>

  <script>
    let deviceIdGlobal = null;

    function showLoading(show) {
      document.getElementById("loading-overlay").style.display = show ? "flex" : "none";
    }

    function showSuccessPopup() {
      const popup = document.getElementById("success-popup");
      popup.style.display = "block";
      setTimeout(() => {
        popup.style.display = "none";
      }, 2000);
    }

    function parseJwt(token) {
      try {
        const base64Url = token.split('.')[1];
        const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
          return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
        }).join(''));
        return JSON.parse(jsonPayload);
      } catch (e) {
        console.error("Failed to parse JWT:", e);
        return null;
      }
    }

    async function fetchUserInfo() {
      const token = localStorage.getItem("jwt_token");
      if (!token) {
        alert("Missing token, please login again.");
        window.location.href = "/";
        return;
      }

      const payload = parseJwt(token);
      if (!payload || !payload.device_id) {
        alert("Invalid token format. Please login again.");
        localStorage.removeItem("jwt_token");
        window.location.href = "/";
        return;
      }

      deviceIdGlobal = payload.device_id;
      checkDeviceStatusPeriodically();

      try {
        const response = await fetch("/user_info", {
          method: "GET",
          headers: {
            Authorization: "Bearer " + token
          }
        });

        if (response.status === 200) {
          const data = await response.json();
          document.getElementById("username").textContent = data.username;
          document.getElementById("email").textContent = data.email;
          document.getElementById("name").textContent = data.name;
        } else {
          alert("Failed to fetch user info. Token may be expired.");
          localStorage.removeItem("jwt_token");
          window.location.href = "/";
        }
      } catch (err) {
        console.error("Error fetching user info:", err);
        alert("Error fetching user info.");
      }
    }

    document.getElementById("logout-btn").addEventListener("click", async () => {
      const token = localStorage.getItem("jwt_token");
      if (!token) {
        window.location.href = "/";
        return;
      }

      try {
        const response = await fetch("/logout", {
          method: "POST",
          headers: {
            Authorization: "Bearer " + token
          }
        });

        if (response.ok) {
          localStorage.removeItem("jwt_token");
          window.location.href = "/";
        } else {
          alert("Logout failed. Please try again.");
        }
      } catch (error) {
        console.error("Logout error:", error);
        alert("Logout error.");
      }
    });

    fetchUserInfo();

    async function checkDeviceStatusPeriodically() {
      const token = localStorage.getItem("jwt_token");
      if (!token || !deviceIdGlobal) return;

      try {
        const res = await fetch(`/check_device_status?device_id=${deviceIdGlobal}`);
        if (res.ok) {
          const data = await res.json();
          if (!data.online) {
            await attemptReconnect();
          } else {
            console.log("✅ Raspberry Pi đang online.");
          }
        }
      } catch (err) {
        console.error("Error checking device status:", err);
      }

      setTimeout(checkDeviceStatusPeriodically, 30000);
    }

    async function attemptReconnect() {
      const confirmReconnect = confirm("⚠ Raspberry Pi hiện offline.\nBạn có muốn thử kết nối lại không?");
      if (!confirmReconnect) {
        await logoutUser();
        return;
      }

      showLoading(true);

      await new Promise(resolve => setTimeout(resolve, 5000)); // Đợi 5 giây

      try {
        const reconnectRes = await fetch(`/check_device_status?device_id=${deviceIdGlobal}`);
        if (reconnectRes.ok) {
          const reconnectData = await reconnectRes.json();
          showLoading(false);
          if (reconnectData.online) {
            showSuccessPopup();
            setTimeout(() => location.reload(), 1000); // reload sau popup
          } else {
            await attemptReconnect(); // Gọi lại vòng lặp reconnect
          }
        } else {
          showLoading(false);
          await attemptReconnect();
        }
      } catch (e) {
        console.error("Reconnect failed:", e);
        showLoading(false);
        await attemptReconnect();
      }
    }

    async function logoutUser() {
      const token = localStorage.getItem("jwt_token");
      if (!token) {
        window.location.href = "/";
        return;
      }

      try {
        await fetch("/logout", {
          method: "POST",
          headers: {
            Authorization: "Bearer " + token
          }
        });
      } catch (e) {
        console.error("Logout error:", e);
      }

      localStorage.removeItem("jwt_token");
      window.location.href = "/";
    }
  </script>
</body>
</html>
